<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Nilai Digital</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div id="loading" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="text-white text-xl flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Memuat Data...
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">Buku Nilai Digital</h1>
            <p class="text-gray-500 mt-2">Pencatatan nilai siswa menggunakan Google Sheet.</p>
            <p id="user-info" class="text-xs text-gray-400 mt-1">ID Sesi: Memuat...</p>
            <div class="mt-4 p-2 bg-red-100 text-red-800 rounded-lg text-sm font-medium">
                PERINGATAN: Aplikasi ini membutuhkan deployment Google Apps Script Web App agar berfungsi.
            </div>
        </header>
        
        <!-- Roster Management Section -->
        <div id="roster-management-card" class="bg-yellow-50 p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex justify-between items-center">
                <span class="text-yellow-800">Manajemen Daftar Siswa (Roster)</span>
                <button id="toggle-roster-btn" class="text-sm text-blue-600 hover:text-blue-800 font-medium bg-yellow-100 px-3 py-1 rounded-full shadow">
                    Tampilkan Form
                </button>
            </h2>
            
            <div id="roster-form-container" class="hidden border-t pt-4 mt-2 border-yellow-200">
                <!-- INPUT NAMA KELAS -->
                <div class="mb-4">
                    <label for="class-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas (Contoh: 7A, 8B)</label>
                    <input type="text" id="class-name" required placeholder="Masukkan nama kelas" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                </div>
                <!-- END INPUT NAMA KELAS -->
                <p class="text-gray-600 mb-3 text-sm">Masukkan daftar nama siswa (satu nama per baris). Daftar yang baru akan menggantikan yang lama.</p>
                <textarea id="roster-textarea" rows="5" placeholder="Contoh:&#10;Budi Santoso&#10;Citra Dewi&#10;Joko Pranata" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500"></textarea>
                <button id="save-roster-btn" class="w-full mt-3 bg-yellow-600 text-white py-2 px-4 rounded-lg hover:bg-yellow-700 transition duration-150 ease-in-out shadow-md font-medium">
                    Simpan dan Perbarui Daftar Siswa
                </button>
                <div id="roster-message-box" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
            </div>
            
            <!-- Display current roster count and Class -->
            <div id="current-roster-display" class="mt-4 flex flex-col sm:flex-row sm:justify-between items-start sm:items-center">
                <div>
                    <span class="font-medium text-gray-600">Jumlah Siswa Terdaftar:</span> 
                    <span id="roster-count" class="text-lg font-bold text-yellow-700">0</span>
                </div>
                <div>
                    <span class="font-medium text-gray-600 sm:ml-4">Kelas Saat Ini:</span> 
                    <span id="current-class-display" class="text-lg font-bold text-yellow-700">Belum Disetel</span>
                </div>
            </div>
        </div>
        
        <!-- Form Input Nilai -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Tambah Nilai Baru (Kelas: <span id="class-info-display" class="text-blue-600">N/A</span>)</h2>
            <!-- Dibuat md:grid-cols-5 untuk menampung 4 input dan 1 tombol -->
            <form id="grade-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div class="md:col-span-1">
                    <label for="student-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Siswa</label>
                    <!-- Select dropdown for Roster integration -->
                    <select id="student-name" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="" disabled selected>Pilih siswa</option>
                    </select>
                </div>
                <div class="md:col-span-1">
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Mata Pelajaran</label>
                    <!-- Mata pelajaran dibatasi hanya Matematika dan Informatika -->
                    <select id="subject" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="" disabled selected>Pilih Mata Pelajaran</option>
                        <option value="Matematika">Matematika</option>
                        <option value="Informatika">Informatika</option>
                    </select>
                </div>
                <!-- Nama Asesmen -->
                <div class="md:col-span-1">
                    <label for="assessment-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Asesmen</label>
                    <input type="text" id="assessment-name" required placeholder="Contoh: Ulangan Harian 1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <!-- Nilai -->
                <div class="md:col-span-1">
                    <label for="score" class="block text-sm font-medium text-gray-700 mb-1">Nilai (0-100)</label>
                    <input type="number" id="score" required min="0" max="100" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="md:col-span-1 w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150 ease-in-out shadow-md font-medium">
                    + Tambah Nilai
                </button>
            </form>
            <div id="message-box" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
        </div>

        <!-- Ringkasan Rata-rata -->
        <div class="bg-blue-50 p-4 rounded-xl shadow-inner mb-8">
            <h2 class="text-xl font-semibold text-blue-800">Ringkasan Nilai</h2>
            <p class="mt-2 text-3xl font-bold text-blue-600">Rata-rata Nilai: <span id="average-score">--</span></p>
        </div>

        <!-- Tabel Nilai -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Daftar Nilai</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Nama Siswa</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Asesmen</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Input</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="grades-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Data nilai akan dimuat di sini oleh JavaScript -->
                    </tbody>
                </table>
            </div>
            <p id="empty-state" class="text-center text-gray-500 py-8 hidden">Belum ada nilai yang dicatat.</p>
        </div>
    </div>

    <!-- Google Sheet Communication Script -->
    <script type="module">
        // --- GLOBAL CONFIGURATION FOR GOOGLE SHEETS ---
        // PENTING: Anda HARUS mengganti URL di bawah ini dengan URL Web App Google Apps Script yang sudah Anda deploy.
        // Script Web App inilah yang akan berkomunikasi dengan Google Sheet Anda.
        const GOOGLE_SHEET_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyK8MEei-bK1KLYmNxPjgG5u3JdLrElwwoW5_BuiKl8BhaVKrRDh6DSV3WfP5IzWyvv/exec"; 
        
        // ID Google Sheet yang Anda berikan.
        const SHEET_ID = "1baFQCLuoYSYGwIc7w_iV0gd8BOLB2S8kKo_toLu5G9s";

        // --- SERVICE INSTANCES (Simplified) ---
        // Menggunakan ID sesi acak karena tidak ada otentikasi. Ganti dengan ID guru jika menggunakan Auth di Apps Script.
        let userId = crypto.randomUUID(); 
        let isAuthReady = true; // Selalu siap karena tidak ada otentikasi kompleks

        // UI elements
        const loadingScreen = document.getElementById('loading');
        const form = document.getElementById('grade-form');
        const messageBox = document.getElementById('message-box');
        const gradesTableBody = document.getElementById('grades-table-body');
        const averageScoreDisplay = document.getElementById('average-score');
        const emptyState = document.getElementById('empty-state');
        const userInfo = document.getElementById('user-info');
        
        // Roster UI elements
        const rosterFormContainer = document.getElementById('roster-form-container');
        const toggleRosterBtn = document.getElementById('toggle-roster-btn');
        const rosterTextarea = document.getElementById('roster-textarea');
        const saveRosterBtn = document.getElementById('save-roster-btn');
        const rosterMessageBox = document.getElementById('roster-message-box');
        const studentNameSelect = document.getElementById('student-name');
        const rosterCountDisplay = document.getElementById('roster-count');

        // UI ELEMENTS FOR CLASS
        const classNameInput = document.getElementById('class-name');
        const currentClassDisplay = document.getElementById('current-class-display');
        const classInfoDisplay = document.getElementById('class-info-display');

        // State to hold current roster and class
        let currentRoster = [];
        let currentClass = 'N/A'; 


        /**
         * Utility function to display temporary messages.
         * @param {string} message The message content.
         * @param {string} type 'success', 'error', or 'info'.
         * @param {HTMLElement} box The message box element to use.
         */
        function displayMessage(message, type, box = messageBox) {
            box.textContent = message;
            box.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');

            if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'info') {
                 box.classList.add('bg-yellow-100', 'text-yellow-700');
            }

            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        /**
         * Sends a request to the Google Sheets Web App endpoint.
         * @param {object} payload The data payload including the 'command'
         * @returns {Promise<object>} The JSON response from the server.
         */
        async function sendSheetRequest(payload) {
            loadingScreen.classList.remove('hidden');
            const dataToSend = {
                sheetId: SHEET_ID,
                userId: userId, // Pass the session ID
                ...payload
            };

            try {
                // Check if the placeholder URL is used
                if (GOOGLE_SHEET_WEB_APP_URL.includes("YOUR_DEPLOYMENT_ID")) {
                    loadingScreen.classList.add('hidden');
                    const errorMsg = "Gagal: URL Apps Script Web App masih menggunakan placeholder (YOUR_DEPLOYMENT_ID).";
                    displayMessage(errorMsg, 'error');
                    throw new Error(errorMsg);
                }

                const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToSend)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                loadingScreen.classList.add('hidden');
                
                if (result.status === 'error') {
                     throw new Error(result.message || "Kesalahan dari server Apps Script.");
                }
                
                return result;

            } catch (error) {
                console.error("Kesalahan koneksi ke Google Sheet API:", error);
                displayMessage(`Gagal berkomunikasi dengan server Sheets: ${error.message}`, 'error', messageBox);
                loadingScreen.classList.add('hidden');
                throw error;
            }
        }

        // --- REPLACEMENT FOR FIREBASE SETUP (Initialization and Polling) ---

        const POLLING_INTERVAL = 10000; // Polling every 10 seconds
        let pollingTimer;

        /**
         * Fetches both grades and roster data, then renders them.
         */
        async function fetchDataAndRender() {
            try {
                const result = await sendSheetRequest({ command: 'GET_ALL' });
                
                // 1. Render Grades
                const gradesData = result.grades || [];
                renderGrades(gradesData);
                
                // 2. Update Roster
                const rosterData = result.roster || { names: [], className: 'Belum Disetel' };
                currentRoster = rosterData.names || [];
                currentClass = rosterData.className || 'Belum Disetel'; 

                // Update Roster Form UI
                rosterTextarea.value = currentRoster.join('\n'); 
                classNameInput.value = currentClass !== 'Belum Disetel' ? currentClass : '';
                
                // Update Grade Form/Display UI
                currentClassDisplay.textContent = currentClass;
                classInfoDisplay.textContent = currentClass;
                populateStudentDropdown(currentRoster);

            } catch (error) {
                // Error handled in sendSheetRequest
            }
        }

        /**
         * Starts the data polling mechanism.
         */
        function startPolling() {
             // Clear any existing timer to prevent duplicates
            if (pollingTimer) {
                clearInterval(pollingTimer);
            }
            
            // Initial fetch
            fetchDataAndRender();
            
            // Start polling timer
            pollingTimer = setInterval(fetchDataAndRender, POLLING_INTERVAL);
        }

        /**
         * Initializes the application (replaces setupFirebase).
         */
        function initializeApp() {
            userInfo.textContent = `ID Sesi: ${userId.substring(0, 8)}...`;
            loadingScreen.classList.remove('hidden');
            startPolling(); // Start polling for data updates
            loadingScreen.classList.add('hidden');
        }

        // --- GRADES FUNCTIONS (Rewritten for Sheet API) ---

        /**
         * Adds a new grade document to Sheet via API.
         */
        async function saveGrade(e) {
            e.preventDefault();

            if (currentClass === 'N/A' || currentClass === 'Belum Disetel') {
                displayMessage("Anda harus mengisi Nama Kelas di bagian Manajemen Daftar Siswa sebelum menambah nilai.", 'error');
                return;
            }

            const name = studentNameSelect.value.trim(); 
            const subject = document.getElementById('subject').value.trim();
            const assessmentName = document.getElementById('assessment-name').value.trim();
            const score = parseInt(document.getElementById('score').value, 10);

            // Validation remains the same
            if (!name || name === "" || !subject || subject === "" || !assessmentName || assessmentName === "" || isNaN(score) || score < 0 || score > 100) {
                displayMessage("Pastikan Anda memilih siswa, mata pelajaran, nama asesmen, dan semua kolom terisi dengan benar (Nilai 0-100).", 'error');
                return;
            }

            try {
                const gradeData = {
                    command: 'ADD_GRADE',
                    docId: crypto.randomUUID(), // Generate unique ID locally
                    name: name,
                    className: currentClass, 
                    subject: subject,
                    assessmentName: assessmentName, 
                    score: score,
                    timestamp: new Date().toISOString() // Use ISO string
                };
                
                await sendSheetRequest(gradeData);

                form.reset();
                studentNameSelect.value = "";
                displayMessage("Nilai berhasil ditambahkan!", 'success');
                fetchDataAndRender(); // Refresh data immediately
            } catch (error) {
                // Error handled in sendSheetRequest
            }
        }

        /**
         * Deletes a grade document from Sheet via API.
         * @param {string} docId The ID of the document to delete.
         */
        async function deleteGrade(docId) {
            if (!await showConfirmation("Apakah Anda yakin ingin menghapus nilai ini?")) return;

            try {
                await sendSheetRequest({
                    command: 'DELETE_GRADE',
                    docId: docId
                });
                
                displayMessage("Nilai berhasil dihapus!", 'success');
                fetchDataAndRender(); // Refresh data immediately
            } catch (error) {
                // Error handled in sendSheetRequest
            }
        }
        
        /**
         * Renders the grades data into the table and updates the average score.
         * @param {Array<object>} grades Array of grade objects (including their docId).
         */
        function renderGrades(grades) {
            gradesTableBody.innerHTML = ''; 

            if (grades.length === 0) {
                emptyState.classList.remove('hidden');
                averageScoreDisplay.textContent = '0.00';
                return;
            }

            emptyState.classList.add('hidden');
            let totalScore = 0;

            // Sort grades by timestamp (descending) in memory. Assuming grade.timestamp is a valid date string.
            grades.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());

            grades.forEach(grade => {
                const score = parseInt(grade.score, 10);
                if (isNaN(score)) return; 

                totalScore += score;

                const row = gradesTableBody.insertRow();
                row.classList.add('hover:bg-gray-50', 'transition', 'duration-100');

                // Helper to format timestamp
                const date = new Date(grade.timestamp || Date.now());
                const formattedDate = date.toLocaleString('id-ID', {
                    day: '2-digit', month: 'short', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });

                // Nama Siswa
                row.insertCell().textContent = grade.name;
                row.cells[0].classList.add('px-4', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900');
                
                // Kelas (Index 1)
                row.insertCell().textContent = grade.className || 'N/A';
                row.cells[1].classList.add('px-4', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-600');

                // Mata Pelajaran (Index 2)
                row.insertCell().textContent = grade.subject;
                row.cells[2].classList.add('px-4', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
                
                // Nama Asesmen (Index 3)
                row.insertCell().textContent = grade.assessmentName || '-'; 
                row.cells[3].classList.add('px-4', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-600', 'font-medium');

                // Nilai (Index 4)
                row.insertCell().textContent = score;
                row.cells[4].classList.add('px-4', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-bold', 'text-blue-600');

                // Waktu Input (Index 5)
                row.insertCell().textContent = formattedDate;
                row.cells[5].classList.add('px-4', 'py-4', 'whitespace-nowrap', 'text-xs', 'text-gray-400');

                // Aksi (Delete Button) (Index 6)
                const actionCell = row.insertCell();
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Hapus';
                deleteBtn.classList.add('text-red-500', 'hover:text-red-700', 'font-medium', 'text-sm', 'transition');
                deleteBtn.onclick = () => deleteGrade(grade.docId); 
                actionCell.appendChild(deleteBtn);
                actionCell.classList.add('px-4', 'py-4', 'whitespace-nowrap', 'text-sm');
            });

            // Calculate and display average
            const average = (totalScore / grades.length).toFixed(2);
            averageScoreDisplay.textContent = average;
        }

        // --- ROSTER FUNCTIONS (Rewritten for Sheet API) ---
        
        /**
         * Saves the list of names and the class name to Sheet via API.
         */
        async function saveRoster() {
            if (!isAuthReady) return;
            
            const className = classNameInput.value.trim();
            if (!className) {
                displayMessage("Nama Kelas tidak boleh kosong.", 'error', rosterMessageBox);
                return;
            }
            
            const rawText = rosterTextarea.value.trim();
            if (!rawText) {
                displayMessage("Kotak teks nama siswa tidak boleh kosong. Masukkan setidaknya satu nama.", 'error', rosterMessageBox);
                return;
            }

            // Split by new line, filter out empty lines, and trim each name
            const names = rawText.split('\n')
                                 .map(name => name.trim())
                                 .filter(name => name.length > 0)
                                 .sort(); // Sort alphabetically for display

            if (names.length === 0) {
                 displayMessage("Tidak ada nama yang valid ditemukan.", 'error', rosterMessageBox);
                return;
            }
            
            try {
                await sendSheetRequest({
                    command: 'UPDATE_ROSTER',
                    names: names,
                    className: className,
                    updatedAt: new Date().toISOString()
                });

                displayMessage(`Berhasil menyimpan ${names.length} nama siswa untuk kelas ${className}!`, 'success', rosterMessageBox);
                fetchDataAndRender(); // Refresh data immediately
            } catch (error) {
                // Error handled in sendSheetRequest
            }
        }

        /**
         * Populates the student name select dropdown with the given names.
         * @param {Array<string>} names List of student names.
         */
        function populateStudentDropdown(names) {
            studentNameSelect.innerHTML = '';
            
            // Add default disabled option
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Pilih siswa";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            studentNameSelect.appendChild(defaultOption);
            
            studentNameSelect.disabled = names.length === 0;

            if (names.length === 0) {
                rosterCountDisplay.textContent = '0';
                // Only show this message if the form is already displayed, otherwise let the fetch handle it.
                if (!rosterFormContainer.classList.contains('hidden')) {
                    displayMessage("Daftar siswa kosong. Silakan gunakan form di atas untuk mengimpor nama.", 'info');
                }
                return;
            }

            names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                studentNameSelect.appendChild(option);
            });
            
            rosterCountDisplay.textContent = names.length;
        }

        // --- CUSTOM CONFIRMATION MODAL (Placeholder) ---
        function showConfirmation(message) {
             console.warn("Konfirmasi otomatis diterima (confirm() diblokir): " + message);
             return true; 
        }


        // --- EVENT LISTENERS AND INITIALIZATION ---
        window.onload = function() {
            loadingScreen.classList.remove('hidden');
            initializeApp(); // Call the new initialization function
            form.addEventListener('submit', saveGrade);
            saveRosterBtn.addEventListener('click', saveRoster);
            
            toggleRosterBtn.addEventListener('click', () => {
                const isHidden = rosterFormContainer.classList.toggle('hidden');
                toggleRosterBtn.textContent = isHidden ? 'Tampilkan Form' : 'Sembunyikan Form';
            });

            // Attach delete function to window for dynamic use in renderGrades
            window.deleteGrade = deleteGrade;
        };
    </script>
</body>
</html>
